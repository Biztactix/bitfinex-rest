using System.Collections.Generic;
using Bitfinex.JsonConverters;
using Bitfinex.Models;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Newtonsoft.Json;

namespace Bitfinex.Tests.Models
{
    [TestClass]
    public class StatsTests
    {
        [TestMethod]
        public void StatsDeserializeTest1()
        {
            //GET: https://api.bitfinex.com/v2/stats1/pos.size:1m:tBTCUSD:long/hist
            string json = "[ [ 1500093840000, 15231.85983157 ], [ 1500093780000, 15222.20717334 ], [ 1500093720000, 15232.36907505 ], [ 1500093660000, 15228.48695498 ], [ 1500093600000, 15229.10184868 ], [ 1500093540000, 15222.826221 ], [ 1500093480000, 15219.26732882 ], [ 1500093420000, 15224.30928207 ], [ 1500093360000, 15230.89866354 ], [ 1500093300000, 15220.86558719 ], [ 1500093240000, 15226.95297291 ], [ 1500093180000, 15225.29479749 ], [ 1500093120000, 15241.31420914 ], [ 1500093060000, 15293.55050882 ], [ 1500093000000, 15293.60275019 ], [ 1500092940000, 15290.91730215 ], [ 1500092880000, 15289.19255742 ], [ 1500092820000, 15295.95908076 ], [ 1500092760000, 15296.97433591 ], [ 1500092700000, 15311.40258141 ], [ 1500092640000, 15313.66587808 ], [ 1500092580000, 15318.39892697 ], [ 1500092520000, 15320.59299776 ], [ 1500092460000, 15325.2897859 ], [ 1500092400000, 15398.21133439 ], [ 1500092340000, 15400.24352068 ], [ 1500092280000, 15403.7085432 ], [ 1500092220000, 15411.30088097 ], [ 1500092160000, 15416.12045021 ], [ 1500092100000, 15413.86114722 ], [ 1500092040000, 15399.15144811 ], [ 1500091980000, 15422.14545073 ], [ 1500091920000, 15424.60621835 ], [ 1500091860000, 15425.89809248 ], [ 1500091800000, 15416.92356844 ], [ 1500091740000, 15394.64693962 ], [ 1500091680000, 15408.01395342 ], [ 1500091620000, 15408.42273459 ], [ 1500091560000, 15431.66084099 ], [ 1500091500000, 15440.32333756 ], [ 1500091440000, 15438.89097298 ], [ 1500091380000, 15428.85219372 ], [ 1500091320000, 15429.10151933 ], [ 1500091260000, 15439.93907027 ], [ 1500091200000, 15432.4930594 ], [ 1500091140000, 15405.65069239 ], [ 1500091080000, 15373.78321039 ], [ 1500091020000, 15318.22377754 ], [ 1500090960000, 15269.37540778 ], [ 1500090900000, 15299.09734332 ], [ 1500090840000, 15333.89672277 ], [ 1500090780000, 15357.80946038 ], [ 1500090720000, 15353.04964833 ], [ 1500090660000, 15353.28792585 ], [ 1500090600000, 15352.22412785 ], [ 1500090540000, 15352.06143252 ], [ 1500090480000, 15336.62951844 ], [ 1500090420000, 15333.25901925 ], [ 1500090360000, 15320.13558957 ], [ 1500090300000, 15320.73408149 ], [ 1500090240000, 15311.54725422 ], [ 1500090180000, 15306.25371221 ], [ 1500090120000, 15306.3637642 ], [ 1500090060000, 15270.90919689 ], [ 1500090000000, 15233.06690044 ], [ 1500089940000, 15218.81492598 ], [ 1500089880000, 15217.33416351 ], [ 1500089820000, 15214.19321812 ], [ 1500089760000, 15211.33440694 ], [ 1500089700000, 15275.17695305 ], [ 1500089640000, 15269.80908519 ], [ 1500089580000, 15316.08834545 ], [ 1500089520000, 15329.31148792 ], [ 1500089460000, 15338.80853724 ], [ 1500089400000, 15350.79856656 ], [ 1500089340000, 15357.38565195 ], [ 1500089280000, 15480.48521171 ], [ 1500089220000, 15479.23740771 ], [ 1500089160000, 15479.03740771 ], [ 1500089100000, 15480.36830215 ], [ 1500089040000, 15480.15977308 ], [ 1500088980000, 15471.1140165 ], [ 1500088920000, 15470.28860656 ], [ 1500088860000, 15467.86359383 ], [ 1500088800000, 15473.44259383 ], [ 1500088740000, 15473.44259383 ], [ 1500088680000, 15473.37657767 ], [ 1500088620000, 15464.62341721 ], [ 1500088560000, 15439.77642582 ], [ 1500088500000, 15436.91659359 ], [ 1500088440000, 15435.21215708 ], [ 1500088380000, 15439.85816968 ], [ 1500088320000, 15440.00508375 ], [ 1500088260000, 15440.01328803 ], [ 1500088200000, 15477.66892043 ], [ 1500088140000, 15473.41498496 ], [ 1500088080000, 15471.93962585 ], [ 1500088020000, 15476.27890248 ], [ 1500087960000, 15468.04539202 ], [ 1500087900000, 15467.27761746 ], [ 1500087840000, 15476.67295242 ], [ 1500087780000, 15464.59910546 ], [ 1500087720000, 15468.88825221 ], [ 1500087660000, 15463.95204925 ], [ 1500087600000, 15481.00653205 ], [ 1500087540000, 15482.93320915 ], [ 1500087480000, 15481.39998574 ], [ 1500087420000, 15481.01823029 ], [ 1500087360000, 15459.57938083 ], [ 1500087300000, 15448.05521381 ], [ 1500087240000, 15435.04350378 ], [ 1500087180000, 15427.45971061 ], [ 1500087120000, 15494.45581034 ], [ 1500087060000, 15506.46048953 ], [ 1500087000000, 15510.59625666 ], [ 1500086940000, 15527.59412255 ], [ 1500086880000, 15529.46401016 ], [ 1500086820000, 15524.67755702 ], [ 1500086760000, 15517.59401016 ], [ 1500086700000, 15519.3946787 ] ]";

            var stats = JsonConvert.DeserializeObject<List<Stat>>(json, new StatsResultConverter());

            Assert.AreEqual(120, stats.Count);

            var stat = stats[0];

            Assert.AreEqual(1500093840000, stat.MTS);
            Assert.AreEqual(15231.85983157, stat.Value);
        }

        [TestMethod]
        public void StatsDeserializeTest2()
        {
            //GET: https://api.bitfinex.com/v2/stats1/pos.size:1m:tBTCUSD:long/last
            string json = "[ 1500093780000, 15222.20717334 ]";

            var stat = JsonConvert.DeserializeObject<Stat>(json, new StatResultConverter());

            Assert.AreEqual(1500093780000, stat.MTS);
            Assert.AreEqual(15222.20717334, stat.Value);
        }

        [TestMethod]
        public void StatsClientSectionLastTest()
        {
            var client = new BitfinexRestClient();
            var stats = client.GetStats(Key.TotalOpenPosition, Symbol.BTCUSD, Side.Long, Section.Last, SortDirection.OldestToNewest);

            Assert.AreEqual(1, stats.Count);
        }

        [TestMethod]
        public void StatsClientSectionHistoricalTest()
        {
            var client = new BitfinexRestClient();
            var stats = client.GetStats(Key.TotalOpenPosition, Symbol.BTCUSD, Side.Long, Section.Historical, SortDirection.OldestToNewest);

            Assert.IsTrue(stats.Count > 1);
        }
    }
}
